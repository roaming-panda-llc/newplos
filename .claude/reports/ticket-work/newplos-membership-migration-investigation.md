# Newplos Membership Migration Investigation

**Date:** 2026-02-19
**Investigator:** Claude Opus 4.6 (AI)

## Summary

Server errors in newplos after pushing the membership app are caused by **two root causes**:

1. **`newplos_db` is missing from the PostgreSQL init script** - The database may not exist on the production server
2. **No migration step exists anywhere in the deployment pipeline** - Even if the database exists, Django migrations are never run during deployment

## Findings

### 1. Migration Files - PASS

- `membership/migrations/__init__.py` exists (empty, correct)
- `membership/migrations/0001_initial.py` exists and is well-formed
- Generated by Django 6.0.2, creates 4 models: MembershipPlan, Space, Member, Lease
- No Django version compatibility issues found - uses standard fields (BigAutoField, CharField, DecimalField, ForeignKey, etc.)
- `membership` is correctly listed in INSTALLED_APPS (settings.py line 54)
- Locally, migrations apply cleanly: `showmigrations` shows `[X] 0001_initial`

### 2. CI/Deploy Logs

- **Latest CI run (22214927613):** Success - Build and Deploy triggered
- **Previous CI failure (22214798189):** Ruff format check failed on `membership/migrations/0001_initial.py` and `tests/membership/querysets_spec.py` - subsequently fixed
- **Deploy workflow runs:** All 5 recent runs succeeded
- CI does run `python manage.py migrate --run-syncdb` (ci.yml line 32) but this is in CI only (SQLite), not production

### 3. Deployment Pipeline - ROOT CAUSE

**The deployment pipeline never runs migrations.** Here is the full chain:

1. **CI (ci.yml):** Runs tests with SQLite, runs migrations in CI only
2. **Build (build-deploy.yml):** Builds Docker image, pushes to GHCR
3. **Dockerfile:** Installs deps, runs `collectstatic`, starts gunicorn - **NO migrate step**
4. **Deploy (deploy-hetzner.yml):** SSH to Hetzner, `docker compose pull && docker compose up -d --force-recreate` - **NO migrate step**
5. **docker-compose.yml:** Starts the newplos container with gunicorn - **NO migrate step**

**This is a systemic issue affecting ALL Django apps**, not just newplos. None of roaming-panda-site, personalhub, rvmechanics, vbstats, or shindig run migrations during deployment either. They work because their tables were presumably created manually or during initial setup.

### 4. Database Init Script - ROOT CAUSE

**File:** `infrastructure/hetzner-migration/postgres/init/01-create-databases.sql`

The following databases are created:
- roaming_panda_db
- personalhub_db
- rvmechanics_db
- vbstats_db
- shindig_db

**`newplos_db` is NOT in this list.** The docker-compose.yml references `newplos_db` in the DATABASE_URL but the init script never creates it.

**However:** This init script only runs on first PostgreSQL startup (`docker-entrypoint-initdb.d`). If postgres was already initialized, adding the database to this file has no effect. The database needs to be created manually on the server.

### 5. Monitoring - NO VISIBILITY

- **Sentry:** No newplos project exists in Sentry (only huub-hi org with huub-backend/huub-frontend)
- **SigNoz:** No logs or traces from newplos. The OTEL env vars are set in docker-compose but `requirements.txt` does not include any OTEL instrumentation packages
- **Health check:** Returns `{"status": "ok"}` without touching the database, so it passes even when the DB is broken

### 6. Local Verification - PASS

- Django 6.0.2 installed
- `manage.py showmigrations membership` shows `[X] 0001_initial` (locally applied)
- `manage.py migrate --check` passes (all migrations applied locally)
- No compatibility issues with the migration file

## What Needs to Be Fixed

### Immediate Fixes (to get membership working in production)

1. **Create `newplos_db` in production PostgreSQL** (if it doesn't exist):
   ```bash
   # SSH to Hetzner server
   docker exec -it postgres psql -U $POSTGRES_USER -c "CREATE DATABASE newplos_db WITH ENCODING='UTF8' LC_COLLATE='en_US.utf8' LC_CTYPE='en_US.utf8' TEMPLATE=template0;"
   docker exec -it postgres psql -U $POSTGRES_USER -d newplos_db -c "CREATE EXTENSION IF NOT EXISTS pg_trgm; CREATE EXTENSION IF NOT EXISTS btree_gin;"
   ```

2. **Run migrations in the production container**:
   ```bash
   docker exec -it newplos python manage.py migrate
   ```

3. **Update the init script** to include newplos_db for future fresh deployments:
   Add to `infrastructure/hetzner-migration/postgres/init/01-create-databases.sql`

### Systemic Fixes (to prevent this class of issue)

4. **Add migration step to deployment** - Either:
   - (a) Add an entrypoint script to the Dockerfile that runs `manage.py migrate` before starting gunicorn, OR
   - (b) Add a migration step to `deploy-hetzner.yml` after pulling the image: `docker exec newplos python manage.py migrate`

   Option (a) is preferred as it's self-contained and runs migrations on every container start.

5. **Add OTEL instrumentation** to newplos `requirements.txt`:
   ```
   opentelemetry-distro
   opentelemetry-exporter-otlp
   opentelemetry-instrumentation-django
   opentelemetry-instrumentation-psycopg
   ```

6. **Add Sentry DSN** configuration for newplos in the docker-compose environment

7. **Improve health check** to verify DB connectivity:
   ```python
   def health_check(request):
       from django.db import connection
       with connection.cursor() as cursor:
           cursor.execute("SELECT 1")
       return JsonResponse({"status": "ok"})
   ```

## Decision Boundaries

- Fixes 1-3 are **Green** (bug fix, proceed autonomously)
- Fix 4 is **Yellow** (new deploy pattern, document reasoning)
- Fix 5-7 are **Yellow** (new dependencies/features, document reasoning)

## Risk Assessment

The current state means:
- The newplos homepage and health check work (no DB needed)
- Any admin page access after login will trigger a 500 error (membership tables don't exist)
- No monitoring exists to detect these errors
